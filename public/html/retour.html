<html>
    <head>
        <script src="/keycloak/keycloak"></script>
    </head>
    <body>
        <script>
            fetch("/keycloak/keycloak.json")
            .then(res => res.json())
            .then(function(front){
                //console.log(front);
                //alert(front);

                var kc = Keycloak(front);
                kc.init()
                .then(function(authenticated) {
                    console.log('keycloak initialised');
                    //console.log(kc.token);
                    if (kc.token) {
                        localStorage.setItem("keycloak_name", kc.tokenParsed.name);

                        const room = document.location.pathname.split('/')[3];
                        fetch("/keycloak/token",
                        {
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json',
                                authorization: 'Bearer ' + kc.token
                            },
                            method: "POST",
                            //mode: 'no-cors',
                            body: JSON.stringify({name: kc.tokenParsed.name, email: kc.tokenParsed.email, room:room})
                        })
                        .then(res => res.json())
                        .then(function(res){ 
                            //document.location.href=res.url;
                            //console.log("### Result of Jitsi Token",res);
                        });
                    }
                    else {
                        // No Token, go back to guest
                        const href = document.location.href.split('/');
                        document.location.href=href[0]+'//'+href[2]+'/'+href[5];
                    }
                });
            });

           /* const front = {
                realm: "global",
                url: "https://iam.bouffel.com/auth/",
                clientId: "dev_frontend",
            };*/
            
        </script>
    </body>
</html>