<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Jitsi Keycloak</title>
  <link href="/assets/favicon.ico" rel="icon" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,nofollow">
  <link href="/assets/styles.css" rel="stylesheet">
  <script src="/keycloak"></script>
</head>

<body>
  <div id="username"></div>
  <div id="jitsi"></div>
  <script src='https://meet.ztag.me/external_api.js'></script>
  <script>    
    if (typeof Keycloak === "function" ) {
      var storage = window.sessionStorage; 

      kc = Keycloak();
      kc.init()
        .success(function(authenticated) {
          console.log('keycloak initialised');
          if (kc.token) {
            console.log(kc.tokenParsed);
            //document.getElementById("username").innerHTML=kc.tokenParsed.name;
            const room = document.location.pathname.split('/')[1];
            if (room) {
              fetch("/token/",
              {
                  headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    authorization: 'Bearer ' + kc.token
                  },
                  method: "POST",
                  body: JSON.stringify({name: kc.tokenParsed.name, email: kc.tokenParsed.email, room:room})
              })
              .then(res => res.json())
              .then(function(res){ 
                //document.location.href=res.url;
                console.log(res);
                const domain = 'meet.ztag.me';
                const options = {
                  /*configOverwrite: {
                      /*hosts: {
                          domain: 'domain.com',
                          muc: 'conference.domain.com',
                          anonymousdomain: 'guest.domain.com',
                      },
                      bosh: '//domain.com/http-bind',
                      startWithAudioMuted: true,
                      startWithVideoMuted: true,
                      // enableUserRolesBasedOnToken: true, - dont work in our case
                  },*/
                  /*interfaceConfigOverwrite: {
                      TOOLBAR_ALWAYS_VISIBLE: true,
                  },*/
                  roomName: res.room,
                  width: '100%',
                  height: '100%',
                  parentNode : document.getElementById("jitsi"),
                  jwt: res.token
                };
                api = new JitsiMeetExternalAPI(domain, options)
                api.addEventListener('readyToClose', function() {
                  console.log('close');
                });
              })
              .catch(function(res){ console.log(res) })
            }
          }
          else {
            kc.login();
          }
        })
        .error(function() {
          console.error('failed to initialize keycloak');
        });
    }
  </script>
</body>

</html>
